<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>File Upload and Viewer</title>
  <!-- NextUI CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nextui/2.0.0-beta/nextui.min.css" integrity="sha384-R5fdYALtv90AKQklBY0oeM5QvuhvHoTk8ZDhZnMCFGhxvGSbNH3UdRh6doDVgBkz" crossorigin="anonymous">
  <style>
    body {
      font-family: "Inter", sans-serif;
      margin: 20px;
      line-height: 1.6;
      background-color: #f9f9f9;
    }
    #fileList a {
      text-decoration: none;
      color: #007BFF;
    }
    #fileList a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-4xl font-bold mb-5 text-center">File Upload and Viewer</h1>

    <!-- File Upload Form -->
    <div class="flex flex-col items-center">
      <form id="uploadForm" class="w-full max-w-md flex items-center gap-4">
        <input 
          type="file" 
          id="fileInput" 
          class="w-full p-2 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" 
        />
        <button 
          type="submit" 
          class="bg-blue-500 text-white px-4 py-2 rounded-md shadow-md hover:bg-blue-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
        >
          Upload
        </button>
      </form>
    </div>

    <h2 class="text-2xl font-semibold mt-10 mb-5 text-center">Uploaded Files</h2>
    <div id="fileList" class="bg-white rounded-lg shadow-md p-5">
      Loading...
    </div>
  </div>

  <script>
    const API_URL = "https://snazzy-stroopwafel-c31ef8.netlify.app/.netlify/functions/uploads";

    // Fetch and display the list of uploaded files
    function fetchFiles() {
      fetch(API_URL)
        .then((response) => response.json())
        .then((files) => {
          const fileList = document.getElementById("fileList");
          fileList.innerHTML = ""; // Clear previous list

          if (files.length === 0) {
            fileList.textContent = "No files uploaded yet.";
          } else {
            files.forEach((file) => {
              const link = document.createElement("a");
              link.href = `${API_URL}?file=${file}`; // Add ?file=filename to URL
              link.textContent = file;
              link.target = "_blank"; // Open in a new tab
              link.className = "text-blue-500 hover:text-blue-700 underline";
              fileList.appendChild(link);
              fileList.appendChild(document.createElement("br"));
            });
          }
        })
        .catch((error) => {
          console.error("Error fetching file list:", error);
          document.getElementById("fileList").textContent =
            "Failed to load files. Please try again later.";
        });
    }

    // Handle file uploads
    document.getElementById("uploadForm").addEventListener("submit", (event) => {
      event.preventDefault(); // Prevent form from reloading the page
      const fileInput = document.getElementById("fileInput");

      if (!fileInput.files.length) {
        alert("Please select a file to upload.");
        return;
      }

      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append("file", file);

      fetch(API_URL, {
        method: "POST",
        headers: {
          "x-file-name": file.name,
        },
        body: file,
      })
        .then((response) => {
          if (response.ok) {
            alert(`File "${file.name}" uploaded successfully.`);
            fileInput.value = ""; // Clear the file input
            fetchFiles(); // Refresh the file list
          } else {
            alert("Failed to upload file. Please try again.");
          }
        })
        .catch((error) => {
          console.error("Error uploading file:", error);
          alert("An error occurred while uploading the file.");
        });
    });

    // Fetch the initial list of files on page load
    fetchFiles();
  </script>
</body>
</html>
